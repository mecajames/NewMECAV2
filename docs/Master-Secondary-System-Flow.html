<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master/Secondary System - Technical Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #1e293b;
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #f8fafc;
        }

        @media print {
            body {
                background: white;
                padding: 20px;
            }
            .page-break {
                page-break-before: always;
            }
        }

        h1 {
            text-align: center;
            color: #ea580c;
            font-size: 2.5rem;
            margin-bottom: 10px;
            border-bottom: 3px solid #ea580c;
            padding-bottom: 15px;
        }

        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 40px;
        }

        h2 {
            color: #0f172a;
            font-size: 1.8rem;
            margin: 40px 0 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            color: white;
            border-radius: 8px;
        }

        h3 {
            color: #334155;
            font-size: 1.3rem;
            margin: 30px 0 15px 0;
            border-left: 4px solid #ea580c;
            padding-left: 15px;
        }

        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .code-block {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 15px 0;
            white-space: pre;
            line-height: 1.5;
        }

        .code-block .comment {
            color: #6b7280;
        }

        .code-block .keyword {
            color: #f472b6;
        }

        .code-block .string {
            color: #a5f3fc;
        }

        .code-block .type {
            color: #fbbf24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        th {
            background: linear-gradient(135deg, #ea580c 0%, #f97316 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        .visual-flow {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .flow-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .flow-step {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
            min-width: 180px;
            border: 2px solid #cbd5e1;
        }

        .flow-step.frontend {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
        }

        .flow-step.backend {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #22c55e;
        }

        .flow-step.database {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .flow-step.service {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-color: #6366f1;
        }

        .flow-step .step-label {
            font-weight: bold;
            font-size: 0.9rem;
        }

        .flow-step .step-desc {
            font-size: 0.8rem;
            margin-top: 5px;
            color: #475569;
        }

        .arrow {
            font-size: 1.5rem;
            color: #ea580c;
        }

        .arrow-down {
            font-size: 1.5rem;
            color: #ea580c;
            margin: 10px 0;
        }

        .file-structure {
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 15px 0;
        }

        .file-structure .folder {
            color: #fbbf24;
        }

        .file-structure .file {
            color: #a5f3fc;
        }

        .file-structure .new {
            color: #4ade80;
        }

        .file-structure .modified {
            color: #f472b6;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .endpoint-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .endpoint-card .method {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        .endpoint-card .method.get {
            background: #dcfce7;
            color: #166534;
        }

        .endpoint-card .method.post {
            background: #dbeafe;
            color: #1e40af;
        }

        .endpoint-card .method.delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .endpoint-card .path {
            font-family: 'Courier New', monospace;
            color: #334155;
        }

        .endpoint-card .description {
            margin-top: 10px;
            color: #64748b;
        }

        .toc {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .toc h3 {
            margin-top: 0;
            border-left: none;
            padding-left: 0;
        }

        .toc ul {
            list-style: none;
            margin-top: 15px;
        }

        .toc li {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .toc li:last-child {
            border-bottom: none;
        }

        .toc a {
            color: #ea580c;
            text-decoration: none;
            font-weight: 500;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            color: #64748b;
        }
    </style>
</head>
<body>
    <h1>Master/Secondary System</h1>
    <p class="subtitle">Technical Architecture & Data Flow Documentation</p>

    <div class="toc">
        <h3>Table of Contents</h3>
        <ul>
            <li><a href="#architecture">1. System Architecture</a></li>
            <li><a href="#database">2. Database Schema Changes</a></li>
            <li><a href="#backend">3. Backend Services</a></li>
            <li><a href="#endpoints">4. API Endpoints</a></li>
            <li><a href="#frontend">5. Frontend Components</a></li>
            <li><a href="#flows">6. Complete Data Flows</a></li>
        </ul>
    </div>

    <!-- SECTION 1: ARCHITECTURE -->
    <h2 id="architecture">1. System Architecture</h2>

    <div class="container">
        <h3 style="margin-top: 0; border-left: none; padding-left: 0;">File Structure</h3>

        <div class="file-structure">
<span class="folder">apps/backend/src/</span>
├── <span class="folder">memberships/</span>
│   ├── <span class="file">memberships.entity.ts</span>      <span class="modified">[MODIFIED]</span> - Added master/secondary fields
│   ├── <span class="file">memberships.controller.ts</span> <span class="modified">[MODIFIED]</span> - Added new endpoints
│   ├── <span class="file">memberships.service.ts</span>    <span class="modified">[MODIFIED]</span> - Updated for secondary support
│   ├── <span class="file">memberships.module.ts</span>     <span class="modified">[MODIFIED]</span> - Registered new service
│   ├── <span class="file new">master-secondary.service.ts</span> <span class="new">[NEW]</span> - Core master/secondary logic
│   └── <span class="file new">meca-id.service.ts</span>        <span class="new">[NEW]</span> - MECA ID assignment
│
├── <span class="folder">profiles/</span>
│   └── <span class="file">profiles.entity.ts</span>        <span class="modified">[MODIFIED]</span> - Added secondary account fields
│
└── <span class="folder">migrations/</span>
    └── <span class="file new">Migration20251229_master_secondary.ts</span> <span class="new">[NEW]</span>

<span class="folder">apps/frontend/src/</span>
├── <span class="folder">memberships/</span>
│   ├── <span class="file">memberships.api-client.ts</span> <span class="modified">[MODIFIED]</span> - Added API methods
│   └── <span class="folder">components/</span>
│       └── <span class="file new">AddSecondaryModal.tsx</span>  <span class="new">[NEW]</span> - Add secondary wizard
│
├── <span class="folder">shared/components/</span>
│   └── <span class="file new">MecaIdSwitcher.tsx</span>     <span class="new">[NEW]</span> - MECA ID dropdown
│
└── <span class="folder">admin/components/</span>
    └── <span class="file">AdminUserWizard.tsx</span>    <span class="modified">[MODIFIED]</span> - Secondary option step

<span class="folder">packages/shared/src/schemas/</span>
└── <span class="file">enums.schema.ts</span>            <span class="modified">[MODIFIED]</span> - Added MembershipAccountType enum
        </div>
    </div>

    <div class="visual-flow">
        <h3 style="text-align: center; border-left: none; padding-left: 0;">High-Level Architecture</h3>

        <div class="flow-row">
            <div class="flow-step frontend">
                <div class="step-label">Frontend</div>
                <div class="step-desc">React + Vite SPA</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step">
                <div class="step-label">API Client</div>
                <div class="step-desc">memberships.api-client.ts</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step backend">
                <div class="step-label">Controller</div>
                <div class="step-desc">memberships.controller.ts</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step service">
                <div class="step-label">MasterSecondaryService</div>
                <div class="step-desc">Business Logic</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step database">
                <div class="step-label">PostgreSQL</div>
                <div class="step-desc">MikroORM Entities</div>
            </div>
        </div>
    </div>

    <div class="page-break"></div>

    <!-- SECTION 2: DATABASE -->
    <h2 id="database">2. Database Schema Changes</h2>

    <h3>MembershipAccountType Enum</h3>
    <div class="code-block"><span class="comment">// packages/shared/src/schemas/enums.schema.ts</span>

<span class="keyword">export enum</span> <span class="type">MembershipAccountType</span> {
  INDEPENDENT = <span class="string">'independent'</span>,  <span class="comment">// Default: standalone membership</span>
  MASTER = <span class="string">'master'</span>,            <span class="comment">// Controls billing for secondaries</span>
  SECONDARY = <span class="string">'secondary'</span>,      <span class="comment">// Linked to master, no billing access</span>
}</div>

    <h3>Membership Entity Changes</h3>
    <table>
        <thead>
            <tr>
                <th>Column</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>accountType</code></td>
                <td>Enum (MembershipAccountType)</td>
                <td>Default: INDEPENDENT</td>
            </tr>
            <tr>
                <td><code>masterMembershipId</code></td>
                <td>UUID (FK to Membership)</td>
                <td>Parent membership (for secondaries)</td>
            </tr>
            <tr>
                <td><code>hasOwnLogin</code></td>
                <td>Boolean</td>
                <td>Whether secondary has own Profile login</td>
            </tr>
            <tr>
                <td><code>masterBillingProfileId</code></td>
                <td>UUID (FK to Profile)</td>
                <td>Profile responsible for billing</td>
            </tr>
            <tr>
                <td><code>linkedAt</code></td>
                <td>Timestamp</td>
                <td>When secondary was linked to master</td>
            </tr>
        </tbody>
    </table>

    <div class="code-block"><span class="comment">// apps/backend/src/memberships/memberships.entity.ts</span>

<span class="comment">// Master/Secondary relationship fields</span>
@Enum(() => MembershipAccountType)
accountType: <span class="type">MembershipAccountType</span> = MembershipAccountType.INDEPENDENT;

@ManyToOne(() => Membership, { nullable: <span class="keyword">true</span> })
masterMembership?: <span class="type">Membership</span>;

@OneToMany(() => Membership, m => m.masterMembership)
secondaryMemberships = <span class="keyword">new</span> Collection&lt;Membership&gt;(<span class="keyword">this</span>);

@Property({ <span class="keyword">nullable</span>: <span class="keyword">true</span> })
hasOwnLogin?: <span class="type">boolean</span>;

@ManyToOne(() => Profile, { nullable: <span class="keyword">true</span> })
masterBillingProfile?: <span class="type">Profile</span>;

@Property({ <span class="keyword">nullable</span>: <span class="keyword">true</span> })
linkedAt?: <span class="type">Date</span>;</div>

    <h3>Profile Entity Changes</h3>
    <table>
        <thead>
            <tr>
                <th>Column</th>
                <th>Type</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>isSecondaryAccount</code></td>
                <td>Boolean</td>
                <td>Default: false</td>
            </tr>
            <tr>
                <td><code>masterProfileId</code></td>
                <td>UUID (FK to Profile)</td>
                <td>Master profile controlling this account</td>
            </tr>
        </tbody>
    </table>

    <div class="page-break"></div>

    <!-- SECTION 3: BACKEND -->
    <h2 id="backend">3. Backend Services</h2>

    <h3>MasterSecondaryService Methods</h3>
    <table>
        <thead>
            <tr>
                <th>Method</th>
                <th>Description</th>
                <th>Returns</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>upgradeToMaster(membershipId)</code></td>
                <td>Upgrade independent membership to master status</td>
                <td>Membership</td>
            </tr>
            <tr>
                <td><code>createSecondaryMembership(dto)</code></td>
                <td>Create new secondary linked to master</td>
                <td>Membership</td>
            </tr>
            <tr>
                <td><code>markSecondaryPaid(id, amount, txId?)</code></td>
                <td>Mark secondary as paid and assign MECA ID</td>
                <td>Membership</td>
            </tr>
            <tr>
                <td><code>getSecondaryMemberships(masterId)</code></td>
                <td>Get all secondaries for a master</td>
                <td>SecondaryMembershipInfo[]</td>
            </tr>
            <tr>
                <td><code>getMasterMembershipInfo(membershipId)</code></td>
                <td>Get master info including secondaries</td>
                <td>MasterMembershipInfo</td>
            </tr>
            <tr>
                <td><code>removeSecondary(secondaryId, userId)</code></td>
                <td>Remove secondary (becomes independent)</td>
                <td>Membership</td>
            </tr>
            <tr>
                <td><code>upgradeToIndependent(secondaryId)</code></td>
                <td>Upgrade secondary to independent status</td>
                <td>Membership</td>
            </tr>
            <tr>
                <td><code>getControlledMecaIds(userId)</code></td>
                <td>Get all MECA IDs user controls</td>
                <td>Array of MECA ID info</td>
            </tr>
            <tr>
                <td><code>hasAccessToMecaId(userId, mecaId)</code></td>
                <td>Check if user has access to MECA ID</td>
                <td>boolean</td>
            </tr>
            <tr>
                <td><code>isSecondaryProfile(profileId)</code></td>
                <td>Check if profile is secondary account</td>
                <td>boolean</td>
            </tr>
        </tbody>
    </table>

    <h3>CreateSecondaryMembershipDto</h3>
    <div class="code-block"><span class="keyword">interface</span> <span class="type">CreateSecondaryMembershipDto</span> {
  masterMembershipId: <span class="type">string</span>;       <span class="comment">// Required: Master membership ID</span>
  membershipTypeConfigId: <span class="type">string</span>;  <span class="comment">// Required: Membership type</span>
  competitorName: <span class="type">string</span>;          <span class="comment">// Required: Display name for competition</span>
  createLogin: <span class="type">boolean</span>;            <span class="comment">// Required: Whether to create profile</span>
  email?: <span class="type">string</span>;                  <span class="comment">// Required if createLogin is true</span>
  vehicleMake?: <span class="type">string</span>;            <span class="comment">// Optional vehicle info</span>
  vehicleModel?: <span class="type">string</span>;
  vehicleColor?: <span class="type">string</span>;
  vehicleLicensePlate?: <span class="type">string</span>;
  teamName?: <span class="type">string</span>;
  teamDescription?: <span class="type">string</span>;
}</div>

    <div class="page-break"></div>

    <!-- SECTION 4: ENDPOINTS -->
    <h2 id="endpoints">4. API Endpoints</h2>

    <div class="endpoint-card">
        <span class="method post">POST</span>
        <span class="path">/api/memberships/:id/upgrade-to-master</span>
        <p class="description">Upgrade an independent membership to master status. Only works for PAID memberships with INDEPENDENT account type.</p>
    </div>

    <div class="endpoint-card">
        <span class="method post">POST</span>
        <span class="path">/api/memberships/:id/secondaries</span>
        <p class="description">Create a new secondary membership linked to the specified master. Body: CreateSecondaryMembershipDto</p>
    </div>

    <div class="endpoint-card">
        <span class="method get">GET</span>
        <span class="path">/api/memberships/:id/secondaries</span>
        <p class="description">Get all secondary memberships for a master. Returns array of SecondaryMembershipInfo.</p>
    </div>

    <div class="endpoint-card">
        <span class="method get">GET</span>
        <span class="path">/api/memberships/:id/master-info</span>
        <p class="description">Get master membership info including all secondaries, max limit, and whether more can be added.</p>
    </div>

    <div class="endpoint-card">
        <span class="method delete">DELETE</span>
        <span class="path">/api/memberships/:id/secondaries/:secondaryId</span>
        <p class="description">Remove a secondary from master (converts to independent). Requires master owner permission.</p>
    </div>

    <div class="endpoint-card">
        <span class="method post">POST</span>
        <span class="path">/api/memberships/:id/upgrade-to-independent</span>
        <p class="description">Upgrade a secondary membership to independent status. Only works for SECONDARY account type.</p>
    </div>

    <div class="endpoint-card">
        <span class="method post">POST</span>
        <span class="path">/api/memberships/:id/mark-secondary-paid</span>
        <p class="description">Mark secondary as paid and assign MECA ID. Body: { amountPaid: number, transactionId?: string }</p>
    </div>

    <div class="endpoint-card">
        <span class="method get">GET</span>
        <span class="path">/api/memberships/user/:userId/controlled-meca-ids</span>
        <p class="description">Get all MECA IDs a user can manage (own + secondaries). Used for MECA ID switcher.</p>
    </div>

    <div class="endpoint-card">
        <span class="method get">GET</span>
        <span class="path">/api/memberships/user/:userId/has-access/:mecaId</span>
        <p class="description">Check if user has access to manage a specific MECA ID.</p>
    </div>

    <div class="endpoint-card">
        <span class="method get">GET</span>
        <span class="path">/api/memberships/profile/:profileId/is-secondary</span>
        <p class="description">Check if a profile is a secondary account (limited billing access).</p>
    </div>

    <div class="page-break"></div>

    <!-- SECTION 5: FRONTEND -->
    <h2 id="frontend">5. Frontend Components</h2>

    <h3>API Client Methods</h3>
    <div class="code-block"><span class="comment">// apps/frontend/src/memberships/memberships.api-client.ts</span>

<span class="comment">// Upgrade to master</span>
<span class="keyword">export async function</span> upgradeToMaster(membershipId: <span class="type">string</span>): <span class="type">Promise&lt;Membership&gt;</span>

<span class="comment">// Create secondary</span>
<span class="keyword">export async function</span> createSecondaryMembership(
  masterMembershipId: <span class="type">string</span>,
  data: <span class="type">CreateSecondaryMembershipDto</span>
): <span class="type">Promise&lt;Membership&gt;</span>

<span class="comment">// Get secondaries</span>
<span class="keyword">export async function</span> getSecondaryMemberships(
  masterMembershipId: <span class="type">string</span>
): <span class="type">Promise&lt;SecondaryMembershipInfo[]&gt;</span>

<span class="comment">// Get master info</span>
<span class="keyword">export async function</span> getMasterMembershipInfo(
  membershipId: <span class="type">string</span>
): <span class="type">Promise&lt;MasterMembershipInfo&gt;</span>

<span class="comment">// Remove secondary</span>
<span class="keyword">export async function</span> removeSecondary(
  masterMembershipId: <span class="type">string</span>,
  secondaryMembershipId: <span class="type">string</span>
): <span class="type">Promise&lt;void&gt;</span>

<span class="comment">// Upgrade to independent</span>
<span class="keyword">export async function</span> upgradeToIndependent(
  membershipId: <span class="type">string</span>
): <span class="type">Promise&lt;Membership&gt;</span>

<span class="comment">// Get controlled MECA IDs</span>
<span class="keyword">export async function</span> getControlledMecaIds(
  userId: <span class="type">string</span>
): <span class="type">Promise&lt;ControlledMecaId[]&gt;</span></div>

    <h3>Key Frontend Components</h3>
    <table>
        <thead>
            <tr>
                <th>Component</th>
                <th>Location</th>
                <th>Purpose</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>MecaIdSwitcher</td>
                <td>shared/components/MecaIdSwitcher.tsx</td>
                <td>Dropdown for masters to switch between MECA IDs</td>
            </tr>
            <tr>
                <td>AddSecondaryModal</td>
                <td>memberships/components/AddSecondaryModal.tsx</td>
                <td>Wizard for adding secondary memberships</td>
            </tr>
            <tr>
                <td>AdminUserWizard</td>
                <td>admin/components/AdminUserWizard.tsx</td>
                <td>Modified to include secondary option step</td>
            </tr>
        </tbody>
    </table>

    <div class="page-break"></div>

    <!-- SECTION 6: FLOWS -->
    <h2 id="flows">6. Complete Data Flows</h2>

    <h3>Flow 1: Admin Creates Secondary Membership</h3>
    <div class="visual-flow">
        <div class="flow-row">
            <div class="flow-step frontend">
                <div class="step-label">AdminUserWizard</div>
                <div class="step-desc">Select "Secondary" option</div>
            </div>
            <span class="arrow">&rarr;</span>
            <div class="flow-step frontend">
                <div class="step-label">Search Master</div>
                <div class="step-desc">Find master by email/MECA ID</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step">
                <div class="step-label">API Call</div>
                <div class="step-desc">POST /memberships/:id/secondaries</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step backend">
                <div class="step-label">MembershipsController</div>
                <div class="step-desc">createSecondaryMembership()</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step service">
                <div class="step-label">MasterSecondaryService</div>
                <div class="step-desc">Validates master, creates secondary</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step database">
                <div class="step-label">Database</div>
                <div class="step-desc">Insert Membership + Profile (if login)</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step" style="background: #dcfce7; border-color: #22c55e;">
                <div class="step-label">Result</div>
                <div class="step-desc">Secondary created with PENDING status</div>
            </div>
        </div>
    </div>

    <h3>Flow 2: Payment & MECA ID Assignment</h3>
    <div class="visual-flow">
        <div class="flow-row">
            <div class="flow-step">
                <div class="step-label">Payment Received</div>
                <div class="step-desc">Stripe webhook or manual</div>
            </div>
            <span class="arrow">&rarr;</span>
            <div class="flow-step backend">
                <div class="step-label">markSecondaryPaid()</div>
                <div class="step-desc">MasterSecondaryService</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step service">
                <div class="step-label">MecaIdService</div>
                <div class="step-desc">assignMecaIdToMembership()</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step database">
                <div class="step-label">Database Update</div>
                <div class="step-desc">paymentStatus = PAID, mecaId = assigned</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step" style="background: #dcfce7; border-color: #22c55e;">
                <div class="step-label">Complete</div>
                <div class="step-desc">Secondary has unique MECA ID, can compete</div>
            </div>
        </div>
    </div>

    <h3>Flow 3: MECA ID Switching (Master Dashboard)</h3>
    <div class="visual-flow">
        <div class="flow-row">
            <div class="flow-step frontend">
                <div class="step-label">Dashboard Load</div>
                <div class="step-desc">MyMecaDashboardPage</div>
            </div>
            <span class="arrow">&rarr;</span>
            <div class="flow-step">
                <div class="step-label">API Call</div>
                <div class="step-desc">getControlledMecaIds(userId)</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step backend">
                <div class="step-label">MasterSecondaryService</div>
                <div class="step-desc">Returns master + all secondary MECA IDs</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step frontend">
                <div class="step-label">MecaIdSwitcher</div>
                <div class="step-desc">Dropdown shows all controlled IDs</div>
            </div>
        </div>

        <div class="flow-row">
            <span class="arrow-down">↓</span>
        </div>

        <div class="flow-row">
            <div class="flow-step" style="background: #dbeafe; border-color: #3b82f6;">
                <div class="step-label">Context Switch</div>
                <div class="step-desc">Dashboard shows selected MECA ID's data</div>
            </div>
        </div>
    </div>

    <div class="info-box">
        <h4>Key Implementation Notes</h4>
        <ul style="margin-left: 20px; margin-top: 10px;">
            <li>Each secondary gets a unique MECA ID upon payment (not at creation)</li>
            <li>Secondary's mecaId is independent - if upgraded to independent, they keep it</li>
            <li>Master's billing profile is copied to secondary at creation time</li>
            <li>Secondary end date inherits from master (or 1 year if master has no end date)</li>
            <li>Maximum 10 secondaries per master (configurable via DEFAULT_MAX_SECONDARIES)</li>
        </ul>
    </div>

    <footer>
        <p>MECA Competition System - Master/Secondary Technical Documentation</p>
        <p style="font-size: 0.9rem; margin-top: 5px;">Generated: December 2025</p>
    </footer>
</body>
</html>
