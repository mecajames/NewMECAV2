<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MECA ID System - Business Logic & Assignment - MECA</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      min-height: 100vh;
      padding: 40px 20px;
      color: #e2e8f0;
      line-height: 1.6;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    .back-link {
      display: inline-block;
      color: #f97316;
      text-decoration: none;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    h1 {
      color: #f97316;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #94a3b8;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    h2 {
      color: #f97316;
      font-size: 1.5rem;
      margin-top: 40px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #475569;
    }
    h3 {
      color: #60a5fa;
      font-size: 1.2rem;
      margin-top: 25px;
      margin-bottom: 12px;
    }
    h4 {
      color: #a78bfa;
      font-size: 1rem;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    p {
      margin-bottom: 15px;
      color: #cbd5e1;
    }
    .card {
      background: #334155;
      border-radius: 12px;
      padding: 24px;
      margin: 20px 0;
      border-left: 4px solid #f97316;
    }
    .card.info {
      border-left-color: #3b82f6;
    }
    .card.success {
      border-left-color: #22c55e;
    }
    .card.warning {
      border-left-color: #eab308;
    }
    .card.purple {
      border-left-color: #a78bfa;
    }
    .card h4 {
      margin-top: 0;
      color: #f8fafc;
    }
    ul, ol {
      margin: 15px 0 15px 25px;
      color: #cbd5e1;
    }
    li {
      margin-bottom: 8px;
    }
    code {
      background: #1e293b;
      padding: 2px 8px;
      border-radius: 4px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.9em;
      color: #fbbf24;
    }
    .path {
      background: #1e293b;
      padding: 8px 16px;
      border-radius: 6px;
      font-family: 'Monaco', 'Consolas', monospace;
      display: inline-block;
      margin: 5px 0;
      color: #22c55e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background: #334155;
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #475569;
    }
    th {
      background: #1e293b;
      color: #f97316;
      font-weight: 600;
    }
    td {
      color: #cbd5e1;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .badge-green {
      background: #166534;
      color: #86efac;
    }
    .badge-red {
      background: #991b1b;
      color: #fca5a5;
    }
    .badge-yellow {
      background: #854d0e;
      color: #fde047;
    }
    .badge-blue {
      background: #1e40af;
      color: #93c5fd;
    }
    .badge-orange {
      background: #9a3412;
      color: #fdba74;
    }
    .badge-purple {
      background: #581c87;
      color: #d8b4fe;
    }
    .flow-diagram {
      background: #1e293b;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      overflow-x: auto;
      white-space: pre;
      color: #94a3b8;
    }
    .highlight {
      color: #f97316;
      font-weight: 600;
    }
    .toc {
      background: #334155;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
    }
    .toc h3 {
      margin-top: 0;
      color: #f8fafc;
    }
    .toc ul {
      margin: 10px 0 0 0;
      list-style: none;
    }
    .toc li {
      margin-bottom: 6px;
    }
    .toc a {
      color: #60a5fa;
      text-decoration: none;
    }
    .toc a:hover {
      text-decoration: underline;
    }
    .id-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    @media (max-width: 768px) {
      .id-range {
        grid-template-columns: 1fr;
      }
    }
    .range-card {
      background: #334155;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .range-card.legacy {
      border: 2px solid #eab308;
    }
    .range-card.new {
      border: 2px solid #22c55e;
    }
    .range-number {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: 'Monaco', 'Consolas', monospace;
      margin: 10px 0;
    }
    .range-card.legacy .range-number {
      color: #fde047;
    }
    .range-card.new .range-number {
      color: #86efac;
    }
    .range-label {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .flowchart-container {
      background: #1e293b;
      border-radius: 12px;
      padding: 30px;
      margin: 30px 0;
      overflow-x: auto;
    }
    .flowchart-container svg {
      display: block;
      margin: 0 auto;
    }
    .step {
      display: flex;
      align-items: flex-start;
      gap: 15px;
      margin: 15px 0;
    }
    .step-number {
      background: #f97316;
      color: #1e293b;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    .step-content {
      flex: 1;
    }
    .code-block {
      background: #1e293b;
      border-radius: 8px;
      padding: 16px;
      margin: 15px 0;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      color: #94a3b8;
      overflow-x: auto;
    }
    .code-block .comment {
      color: #6b7280;
    }
    .code-block .function {
      color: #60a5fa;
    }
    .code-block .number {
      color: #fbbf24;
    }
    .code-block .string {
      color: #86efac;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">&larr; Back to Documentation</a>

    <h1>MECA ID System</h1>
    <p class="subtitle">Business Logic, ID Ranges, and Assignment Process</p>

    <div class="toc">
      <h3>Table of Contents</h3>
      <ul>
        <li><a href="#overview">1. System Overview</a></li>
        <li><a href="#what-is-meca-id">2. What is a MECA ID?</a></li>
        <li><a href="#id-ranges">3. MECA ID Ranges</a></li>
        <li><a href="#meca-id-usage">4. How MECA ID is Used in the System</a></li>
        <li><a href="#membership-correlation">5. MECA ID & Membership Correlation</a></li>
        <li><a href="#assignment-flow">6. Assignment Flow & Logic</a></li>
        <li><a href="#flowchart">7. Assignment Flowchart</a></li>
        <li><a href="#active-vs-expired">8. Active vs Expired Memberships</a></li>
        <li><a href="#renewal-logic">9. Renewal & Reactivation Logic (90-Day Rule)</a></li>
        <li><a href="#secondary-memberships">10. Secondary Membership IDs</a></li>
        <li><a href="#legacy-import">11. Legacy ID Import & Migration</a></li>
        <li><a href="#special-roles">12. Special Role IDs (Judges, EDs)</a></li>
        <li><a href="#database">13. Database Implementation</a></li>
        <li><a href="#business-logic-summary">14. Business Logic Summary</a></li>
        <li><a href="#super-admin">15. Super Admin MECA ID Override (Protected)</a></li>
        <li><a href="#troubleshooting">16. Troubleshooting</a></li>
      </ul>
    </div>

    <h2 id="overview">1. System Overview</h2>
    <p>MECA IDs are unique identifiers assigned to competitors, retailers, manufacturers, judges, and event directors in the MECA system. Each ID is permanent and tied to either a <strong>membership</strong> or a <strong>profile</strong> (for special roles).</p>

    <div class="card info">
      <h4>Key Principles</h4>
      <ul>
        <li>Every paid competitor membership gets a unique MECA ID</li>
        <li>A single person can have multiple MECA IDs (different memberships, different vehicles)</li>
        <li>MECA IDs are never reused after the 90-day reactivation window</li>
        <li>Legacy IDs (imported from old system) are preserved and protected</li>
        <li>New IDs start at <code>701500</code> to avoid conflicts with legacy data</li>
        <li>MECA ID is the primary identifier for competition results and standings</li>
      </ul>
    </div>

    <h2 id="what-is-meca-id">2. What is a MECA ID?</h2>
    <p>A MECA ID is a <strong>unique numerical identifier</strong> that represents a competitor's official registration with MECA (Mobile Electronics Competition Association). Think of it like a driver's license number for car audio competition.</p>

    <div class="card">
      <h4>MECA ID Represents:</h4>
      <ul>
        <li><strong>Identity:</strong> A unique, trackable identifier for a competitor/membership</li>
        <li><strong>Vehicle:</strong> Each MECA ID is tied to one vehicle at a time</li>
        <li><strong>Competition History:</strong> All results are linked to the MECA ID, not the person's name</li>
        <li><strong>Membership Status:</strong> The ID's validity depends on membership being active</li>
      </ul>
    </div>

    <div class="card warning">
      <h4>Important Distinction</h4>
      <p><strong>One Person ≠ One MECA ID</strong></p>
      <p>A person can have multiple MECA IDs if they:</p>
      <ul>
        <li>Compete with multiple vehicles (each vehicle = separate secondary membership = separate MECA ID)</li>
        <li>Have multiple membership types (Competitor + Retailer = 2 different IDs)</li>
        <li>Let their membership lapse more than 90 days and re-register (new ID assigned)</li>
      </ul>
    </div>

    <h2 id="id-ranges">3. MECA ID Ranges</h2>
    <p>The system uses different ID ranges to distinguish between legacy imported data and new system assignments:</p>

    <div class="id-range">
      <div class="range-card legacy">
        <div class="range-label">Legacy / Imported IDs</div>
        <div class="range-number">1 - 701,499</div>
        <div class="range-label">Reserved for imported data from old system</div>
      </div>
      <div class="range-card new">
        <div class="range-label">New System IDs</div>
        <div class="range-number">701,500+</div>
        <div class="range-label">Auto-assigned by the system</div>
      </div>
    </div>

    <table>
      <tr>
        <th>Range</th>
        <th>Type</th>
        <th>Description</th>
        <th>Assignment</th>
      </tr>
      <tr>
        <td><code>1 - 699,999</code></td>
        <td><span class="badge badge-yellow">Legacy</span></td>
        <td>Historical IDs from old MECA system</td>
        <td>Imported during migration</td>
      </tr>
      <tr>
        <td><code>700,000 - 701,499</code></td>
        <td><span class="badge badge-yellow">Buffer</span></td>
        <td>Reserved buffer zone</td>
        <td>Manual assignment only</td>
      </tr>
      <tr>
        <td><code>701,500+</code></td>
        <td><span class="badge badge-green">New System</span></td>
        <td>All new memberships</td>
        <td>Automatic via <code>get_next_meca_id()</code></td>
      </tr>
    </table>

    <h2 id="meca-id-usage">4. How MECA ID is Used in the System</h2>
    <p>The MECA ID is the <strong>central identifier</strong> used throughout the entire system. Here's everywhere it appears:</p>

    <h3>Competition Registration</h3>
    <div class="card success">
      <h4>Event Check-In</h4>
      <ul>
        <li>Competitor presents their MECA ID at event registration</li>
        <li>System verifies membership is <strong>active</strong> (not expired)</li>
        <li>If active, competitor is registered for the event under that MECA ID</li>
        <li>If expired, competitor cannot register until they renew</li>
      </ul>
    </div>

    <h3>Results Entry</h3>
    <div class="card info">
      <h4>Linking Results to Competitors</h4>
      <p>When judges/event directors enter competition results:</p>
      <ul>
        <li>Results are linked to the <strong>MECA ID</strong>, not competitor name</li>
        <li>System validates the MECA ID exists and has an active membership</li>
        <li>TermLab imports also reference MECA IDs for automatic result matching</li>
        <li>Excel imports can include MECA ID column for bulk result entry</li>
      </ul>
    </div>

    <h3>Standings & Points</h3>
    <div class="card purple">
      <h4>Points Calculation</h4>
      <ul>
        <li>Points are accumulated <strong>per MECA ID</strong> throughout the season</li>
        <li>Standings show competitors by their MECA ID and total points</li>
        <li>If a competitor gets a new MECA ID (after 90-day lapse), they start fresh with 0 points</li>
        <li>Old MECA ID's history is preserved but no longer accumulates</li>
      </ul>
    </div>

    <h3>Where MECA ID Appears in the System</h3>
    <table>
      <tr>
        <th>Feature</th>
        <th>How MECA ID is Used</th>
      </tr>
      <tr>
        <td>Member Dashboard</td>
        <td>Displayed prominently as the member's identifier</td>
      </tr>
      <tr>
        <td>Competition Results</td>
        <td>Links each result to a specific MECA ID</td>
      </tr>
      <tr>
        <td>Season Standings</td>
        <td>Points aggregated by MECA ID</td>
      </tr>
      <tr>
        <td>Event Registration</td>
        <td>Required for event check-in</td>
      </tr>
      <tr>
        <td>Admin Member Lookup</td>
        <td>Search members by MECA ID</td>
      </tr>
      <tr>
        <td>TermLab Integration</td>
        <td>Matches imported results to MECA IDs</td>
      </tr>
      <tr>
        <td>Orders & Invoices</td>
        <td>References MECA ID for membership purchases</td>
      </tr>
      <tr>
        <td>Team Membership</td>
        <td>MECA ID identifies team members</td>
      </tr>
    </table>

    <h2 id="membership-correlation">5. MECA ID & Membership Correlation</h2>
    <p>The MECA ID and Membership are closely linked but serve different purposes:</p>

    <table>
      <tr>
        <th>Aspect</th>
        <th>Membership</th>
        <th>MECA ID</th>
      </tr>
      <tr>
        <td><strong>What it is</strong></td>
        <td>A time-bound subscription</td>
        <td>A permanent identifier</td>
      </tr>
      <tr>
        <td><strong>Expires?</strong></td>
        <td>Yes (typically 1 year)</td>
        <td>Never expires, but becomes inactive</td>
      </tr>
      <tr>
        <td><strong>Storage</strong></td>
        <td><code>memberships</code> table</td>
        <td><code>memberships.meca_id</code> field</td>
      </tr>
      <tr>
        <td><strong>Created when</strong></td>
        <td>User purchases membership</td>
        <td>Membership payment confirmed</td>
      </tr>
      <tr>
        <td><strong>Renewed</strong></td>
        <td>New record or extended dates</td>
        <td>Same ID if within 90 days</td>
      </tr>
    </table>

    <div class="card">
      <h4>The Relationship</h4>
      <p><code>Membership</code> → <em>has one</em> → <code>MECA ID</code></p>
      <p>The MECA ID is a <strong>property of the membership</strong>. When you have an active membership, your MECA ID is considered "active". When your membership expires, the MECA ID is still there but considered "inactive" for competition purposes.</p>
    </div>

    <h3>Membership Status Impact on MECA ID</h3>
    <table>
      <tr>
        <th>Membership Status</th>
        <th>Payment Status</th>
        <th>MECA ID State</th>
        <th>Can Compete?</th>
      </tr>
      <tr>
        <td><span class="badge badge-green">Active</span></td>
        <td>Paid</td>
        <td>Valid & Active</td>
        <td>Yes</td>
      </tr>
      <tr>
        <td><span class="badge badge-yellow">Pending</span></td>
        <td>Pending</td>
        <td>Not Yet Assigned</td>
        <td>No</td>
      </tr>
      <tr>
        <td><span class="badge badge-red">Expired</span></td>
        <td>Paid (previously)</td>
        <td>Inactive</td>
        <td>No</td>
      </tr>
      <tr>
        <td><span class="badge badge-red">Expired 90+ days</span></td>
        <td>Paid (previously)</td>
        <td>Retired (cannot reuse)</td>
        <td>No</td>
      </tr>
    </table>

    <h2 id="assignment-flow">6. Assignment Flow & Logic</h2>
    <p>When a membership is created and paid, the system follows this logic to assign a MECA ID:</p>

    <h3>For New Memberships</h3>
    <div class="step">
      <div class="step-number">1</div>
      <div class="step-content">
        <strong>Membership Created</strong><br>
        User purchases a competitor, retailer, or manufacturer membership
      </div>
    </div>

    <div class="step">
      <div class="step-number">2</div>
      <div class="step-content">
        <strong>Payment Confirmed</strong><br>
        Stripe webhook confirms payment (or admin marks as paid)
      </div>
    </div>

    <div class="step">
      <div class="step-number">3</div>
      <div class="step-content">
        <strong>Check for Previous Membership</strong><br>
        System looks for expired memberships in the same category for this user
      </div>
    </div>

    <div class="step">
      <div class="step-number">4</div>
      <div class="step-content">
        <strong>Apply 90-Day Rule</strong><br>
        If previous membership expired &lt; 90 days ago, reuse that MECA ID. Otherwise, get new ID.
      </div>
    </div>

    <div class="step">
      <div class="step-number">5</div>
      <div class="step-content">
        <strong>Assign MECA ID</strong><br>
        Call <code>get_next_meca_id()</code> database function for atomic, thread-safe ID generation
      </div>
    </div>

    <div class="step">
      <div class="step-number">6</div>
      <div class="step-content">
        <strong>Record History</strong><br>
        Create entry in <code>meca_id_history</code> table for audit trail
      </div>
    </div>

    <h2 id="flowchart">7. Assignment Flowchart</h2>
    <p>This flowchart shows the complete decision logic for <code>assignMecaIdToMembership()</code>:</p>

    <div class="flowchart-container">
      <svg width="700" height="650" viewBox="0 0 700 650" xmlns="http://www.w3.org/2000/svg">
        <!-- Background -->
        <rect width="700" height="650" fill="#1e293b"/>

        <!-- Title -->
        <text x="350" y="30" text-anchor="middle" fill="#f97316" font-size="16" font-weight="bold" font-family="system-ui">assignMecaIdToMembership() Flow</text>

        <!-- Start -->
        <ellipse cx="350" cy="70" rx="80" ry="25" fill="#334155" stroke="#f97316" stroke-width="2"/>
        <text x="350" y="75" text-anchor="middle" fill="#f8fafc" font-size="12" font-family="system-ui">Start: Membership Paid</text>

        <!-- Arrow 1 -->
        <line x1="350" y1="95" x2="350" y2="130" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Decision 1: Previous Membership? -->
        <polygon points="350,130 450,175 350,220 250,175" fill="#334155" stroke="#60a5fa" stroke-width="2"/>
        <text x="350" y="170" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">Previous</text>
        <text x="350" y="185" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">Membership?</text>

        <!-- Arrow: No previous -->
        <line x1="450" y1="175" x2="550" y2="175" stroke="#64748b" stroke-width="2"/>
        <line x1="550" y1="175" x2="550" y2="450" stroke="#64748b" stroke-width="2"/>
        <text x="480" y="165" fill="#94a3b8" font-size="10" font-family="system-ui">NO</text>

        <!-- Arrow: Yes previous -->
        <line x1="350" y1="220" x2="350" y2="260" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
        <text x="365" y="245" fill="#94a3b8" font-size="10" font-family="system-ui">YES</text>

        <!-- Decision 2: Has MECA ID & End Date? -->
        <polygon points="350,260 450,305 350,350 250,305" fill="#334155" stroke="#60a5fa" stroke-width="2"/>
        <text x="350" y="300" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">Has MECA ID</text>
        <text x="350" y="315" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">& End Date?</text>

        <!-- Arrow: No MECA ID -->
        <line x1="450" y1="305" x2="550" y2="305" stroke="#64748b" stroke-width="2"/>
        <text x="480" y="295" fill="#94a3b8" font-size="10" font-family="system-ui">NO</text>

        <!-- Arrow: Yes has MECA ID -->
        <line x1="350" y1="350" x2="350" y2="390" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
        <text x="365" y="375" fill="#94a3b8" font-size="10" font-family="system-ui">YES</text>

        <!-- Decision 3: Within 90 Days? -->
        <polygon points="350,390 450,435 350,480 250,435" fill="#334155" stroke="#eab308" stroke-width="2"/>
        <text x="350" y="430" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">Expired</text>
        <text x="350" y="445" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">&lt; 90 days?</text>

        <!-- Arrow: More than 90 days -->
        <line x1="450" y1="435" x2="550" y2="435" stroke="#64748b" stroke-width="2"/>
        <text x="475" y="425" fill="#94a3b8" font-size="10" font-family="system-ui">NO (&gt;90)</text>

        <!-- Arrow: Within 90 days -->
        <line x1="250" y1="435" x2="150" y2="435" stroke="#64748b" stroke-width="2"/>
        <line x1="150" y1="435" x2="150" y2="510" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>
        <text x="180" y="425" fill="#94a3b8" font-size="10" font-family="system-ui">YES (&lt;90)</text>

        <!-- REUSE Box -->
        <rect x="70" y="510" rx="8" ry="8" width="160" height="60" fill="#166534" stroke="#22c55e" stroke-width="2"/>
        <text x="150" y="535" text-anchor="middle" fill="#f8fafc" font-size="12" font-weight="bold" font-family="system-ui">REUSE</text>
        <text x="150" y="555" text-anchor="middle" fill="#d1fae5" font-size="11" font-family="system-ui">Same MECA ID</text>

        <!-- NEW ID Box -->
        <rect x="470" y="450" rx="8" ry="8" width="160" height="60" fill="#1e40af" stroke="#3b82f6" stroke-width="2"/>
        <text x="550" y="475" text-anchor="middle" fill="#f8fafc" font-size="12" font-weight="bold" font-family="system-ui">NEW ID</text>
        <text x="550" y="495" text-anchor="middle" fill="#bfdbfe" font-size="11" font-family="system-ui">get_next_meca_id()</text>

        <!-- Arrow from NEW to History -->
        <line x1="550" y1="510" x2="550" y2="550" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Arrow from REUSE to History -->
        <line x1="150" y1="570" x2="150" y2="590" stroke="#64748b" stroke-width="2"/>
        <line x1="150" y1="590" x2="350" y2="590" stroke="#64748b" stroke-width="2"/>
        <line x1="350" y1="590" x2="350" y2="555" stroke="#64748b" stroke-width="2"/>

        <!-- Arrow from NEW to merge -->
        <line x1="550" y1="550" x2="550" y2="590" stroke="#64748b" stroke-width="2"/>
        <line x1="550" y1="590" x2="350" y2="590" stroke="#64748b" stroke-width="2"/>

        <!-- History Box -->
        <rect x="270" y="550" rx="8" ry="8" width="160" height="40" fill="#334155" stroke="#a78bfa" stroke-width="2"/>
        <text x="350" y="575" text-anchor="middle" fill="#f8fafc" font-size="11" font-family="system-ui">Record in History</text>

        <!-- End -->
        <ellipse cx="350" cy="620" rx="60" ry="20" fill="#334155" stroke="#22c55e" stroke-width="2"/>
        <text x="350" y="625" text-anchor="middle" fill="#86efac" font-size="11" font-family="system-ui">Complete</text>

        <!-- Arrow to End -->
        <line x1="350" y1="590" x2="350" y2="600" stroke="#64748b" stroke-width="2" marker-end="url(#arrowhead)"/>

        <!-- Arrow marker definition -->
        <defs>
          <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
          </marker>
        </defs>

        <!-- Legend -->
        <rect x="20" y="20" width="150" height="80" rx="6" fill="#0f172a" stroke="#475569"/>
        <text x="30" y="40" fill="#94a3b8" font-size="10" font-family="system-ui">Legend:</text>
        <rect x="30" y="50" width="12" height="12" fill="#60a5fa"/>
        <text x="48" y="60" fill="#cbd5e1" font-size="10" font-family="system-ui">Decision</text>
        <rect x="30" y="68" width="12" height="12" fill="#22c55e"/>
        <text x="48" y="78" fill="#cbd5e1" font-size="10" font-family="system-ui">Reuse ID</text>
        <rect x="30" y="86" width="12" height="12" fill="#3b82f6"/>
        <text x="48" y="96" fill="#cbd5e1" font-size="10" font-family="system-ui">New ID</text>
      </svg>
    </div>

    <h2 id="active-vs-expired">8. Active vs Expired Memberships</h2>
    <p>Understanding how MECA IDs behave with active and expired memberships is critical for the system:</p>

    <h3>Active Membership</h3>
    <div class="card success">
      <h4>When Membership is Active</h4>
      <ul>
        <li><strong>MECA ID is fully valid</strong> - can register for events and compete</li>
        <li>Results can be submitted under this MECA ID</li>
        <li>Points accumulate in standings</li>
        <li>Member appears in active member lists</li>
        <li>ID is displayed with active status badge</li>
      </ul>
    </div>

    <h3>Expired Membership (Within 90 Days)</h3>
    <div class="card warning">
      <h4>Grace Period</h4>
      <ul>
        <li><strong>MECA ID is inactive</strong> - cannot compete</li>
        <li>Member is prompted to renew when logging in</li>
        <li>If they renew, the <strong>same MECA ID</strong> is reactivated</li>
        <li>All previous points and history remain linked</li>
        <li>No interruption to competition history</li>
      </ul>
    </div>

    <h3>Expired Membership (Over 90 Days)</h3>
    <div class="card">
      <h4>Fresh Start</h4>
      <ul>
        <li><strong>Old MECA ID is permanently retired</strong></li>
        <li>If member re-registers, they get a <strong>brand new MECA ID</strong></li>
        <li>Old competition history stays with old ID</li>
        <li>New ID starts with 0 points</li>
        <li>This is intentional - encourages timely renewals</li>
      </ul>
    </div>

    <h3>Why 90 Days?</h3>
    <div class="card info">
      <h4>Business Rationale</h4>
      <p>The 90-day window exists to:</p>
      <ul>
        <li>Give members reasonable time to renew without losing their ID</li>
        <li>Allow for billing issues, vacations, or life circumstances</li>
        <li>But not so long that people abuse the system by only paying for "active" seasons</li>
        <li>Keep the standings fair - long-lapsed members shouldn't carry over accumulated advantages</li>
      </ul>
    </div>

    <h2 id="renewal-logic">9. Renewal & Reactivation Logic (90-Day Rule)</h2>
    <p>The 90-day reactivation window allows members to keep their MECA ID when renewing promptly:</p>

    <h3>Within 90 Days of Expiry</h3>
    <div class="card success">
      <h4>MECA ID Preserved</h4>
      <p>If a member renews within 90 days of their membership expiring:</p>
      <ul>
        <li>Same MECA ID is assigned to the new membership</li>
        <li>Competition history remains linked</li>
        <li>Points and standings continue</li>
        <li>History record notes "reactivation"</li>
      </ul>
    </div>

    <h3>After 90 Days</h3>
    <div class="card warning">
      <h4>New MECA ID Assigned</h4>
      <p>If more than 90 days have passed since expiry:</p>
      <ul>
        <li>A brand new MECA ID is assigned</li>
        <li>Old competition history stays with old ID</li>
        <li>Fresh start for standings/points</li>
        <li>Old ID is "retired" but preserved in history</li>
      </ul>
    </div>

    <div class="code-block">
<span class="comment">// Simplified renewal logic in assignMecaIdToMembership()</span>
<span class="function">if</span> (previousMembership?.mecaId && previousMembership.endDate) {
  <span class="function">const</span> daysSinceExpiry = getDaysSinceExpiry(previousMembership.endDate);

  <span class="function">if</span> (daysSinceExpiry <= <span class="number">90</span>) {
    <span class="comment">// Reuse same MECA ID</span>
    membership.mecaId = previousMembership.mecaId;
    recordReactivation(mecaId, membership);
  } <span class="function">else</span> {
    <span class="comment">// Get new MECA ID</span>
    membership.mecaId = <span class="function">await</span> getNextMecaId();
    createHistoryRecord(newMecaId, membership);
  }
}
    </div>

    <h2 id="secondary-memberships">10. Secondary Membership IDs</h2>
    <p>Secondary memberships (family members or additional vehicles sharing a master account) each get their own unique MECA ID:</p>

    <h3>Relationship Types</h3>
    <table>
      <tr>
        <th>Relationship</th>
        <th>Competitor Name</th>
        <th>Vehicle Info</th>
        <th>Use Case</th>
      </tr>
      <tr>
        <td><strong>Self (Another Vehicle)</strong></td>
        <td>Uses master's name</td>
        <td>Required (unique)</td>
        <td>Same person, multiple competition vehicles</td>
      </tr>
      <tr>
        <td><strong>Spouse</strong></td>
        <td>Required</td>
        <td>Required</td>
        <td>Partner who competes</td>
      </tr>
      <tr>
        <td><strong>Child</strong></td>
        <td>Required</td>
        <td>Required</td>
        <td>Family member who competes</td>
      </tr>
      <tr>
        <td><strong>Sibling</strong></td>
        <td>Required</td>
        <td>Required</td>
        <td>Brother/sister who competes</td>
      </tr>
      <tr>
        <td><strong>Friend</strong></td>
        <td>Required</td>
        <td>Required</td>
        <td>Non-family sharing billing</td>
      </tr>
    </table>

    <div class="card purple">
      <h4>Secondary Membership Flow</h4>
      <ol>
        <li>Master account owner adds a secondary member</li>
        <li>Secondary membership is created with <code>paymentStatus: PENDING</code></li>
        <li>An invoice is generated for the secondary membership fee</li>
        <li>When invoice is paid, <code>markSecondaryPaid()</code> is called</li>
        <li>This calls <code>assignMecaIdToMembership(secondary, undefined, em)</code></li>
        <li>Since there's no previous membership, a NEW unique MECA ID is assigned</li>
      </ol>
    </div>

    <table>
      <tr>
        <th>Scenario</th>
        <th>MECA ID Assignment</th>
      </tr>
      <tr>
        <td>Master membership</td>
        <td>Gets its own unique MECA ID (e.g., 701500)</td>
      </tr>
      <tr>
        <td>Secondary #1 (Spouse)</td>
        <td>Gets its own unique MECA ID (e.g., 701501)</td>
      </tr>
      <tr>
        <td>Secondary #2 (Child)</td>
        <td>Gets its own unique MECA ID (e.g., 701502)</td>
      </tr>
      <tr>
        <td>Secondary (Self - different vehicle)</td>
        <td>Gets its own unique MECA ID (e.g., 701503)</td>
      </tr>
    </table>

    <h2 id="legacy-import">11. Legacy ID Import & Migration</h2>
    <p>When migrating data from the old MECA system, legacy MECA IDs are preserved:</p>

    <div class="card warning">
      <h4>Import Rules</h4>
      <ul>
        <li>Legacy IDs are imported directly into the <code>meca_id</code> field on memberships</li>
        <li>The profile's <code>meca_id</code> field stores the "primary" MECA ID for display purposes</li>
        <li>Legacy IDs are protected - the system will never auto-assign an ID in the legacy range</li>
        <li>If a legacy user renews after 90+ days, they get a NEW ID (701500+), not reuse their legacy ID</li>
      </ul>
    </div>

    <h3>Profile vs Membership MECA ID</h3>
    <table>
      <tr>
        <th>Location</th>
        <th>Field</th>
        <th>Purpose</th>
        <th>Type</th>
      </tr>
      <tr>
        <td>profiles table</td>
        <td><code>meca_id</code></td>
        <td>Display ID (special roles, legacy display)</td>
        <td>TEXT (string)</td>
      </tr>
      <tr>
        <td>memberships table</td>
        <td><code>meca_id</code></td>
        <td>Actual membership ID for competitions</td>
        <td>INTEGER (unique)</td>
      </tr>
    </table>

    <div class="card info">
      <h4>Why Two Fields?</h4>
      <p>The profile <code>meca_id</code> is for:</p>
      <ul>
        <li>Special roles (Judges, Event Directors) who need an ID but don't have a membership</li>
        <li>Legacy display purposes during migration</li>
        <li>Quick lookup without joining to memberships table</li>
      </ul>
      <p>The membership <code>meca_id</code> is the authoritative ID used for:</p>
      <ul>
        <li>Competition registration</li>
        <li>Results tracking</li>
        <li>Standings calculations</li>
      </ul>
    </div>

    <h2 id="special-roles">12. Special Role IDs (Judges, Event Directors)</h2>
    <p>Judges and Event Directors can receive MECA IDs even without a competitor membership:</p>

    <div class="card info">
      <h4>Special Role Assignment</h4>
      <ul>
        <li>IDs are assigned to the <strong>profile</strong>, not a membership</li>
        <li>Uses the same <code>get_next_meca_id()</code> function</li>
        <li>Only profiles with specific roles can receive IDs this way:
          <ul>
            <li><code>event_director</code></li>
            <li><code>judge</code></li>
            <li><code>admin</code></li>
          </ul>
        </li>
        <li>Stored in <code>profiles.meca_id</code> as a string</li>
      </ul>
    </div>

    <h2 id="database">13. Database Implementation</h2>
    <p>The MECA ID system relies on a PostgreSQL function for thread-safe ID generation:</p>

    <h3>The <code>get_next_meca_id()</code> Function</h3>
    <div class="code-block">
<span class="comment">-- Atomic function to get next available MECA ID</span>
<span class="function">CREATE FUNCTION</span> get_next_meca_id()
<span class="function">RETURNS</span> <span class="string">INTEGER</span> <span class="function">AS</span> $$
<span class="function">DECLARE</span>
  next_id <span class="string">INTEGER</span>;
<span class="function">BEGIN</span>
  <span class="comment">-- Get max ID from memberships, starting at 701499 minimum</span>
  <span class="function">SELECT</span> COALESCE(MAX(meca_id), <span class="number">701499</span>) + <span class="number">1</span>
  <span class="function">INTO</span> next_id
  <span class="function">FROM</span> memberships
  <span class="function">WHERE</span> meca_id >= <span class="number">701500</span>;

  <span class="function">RETURN</span> next_id;
<span class="function">END</span>;
$$ <span class="function">LANGUAGE</span> plpgsql;
    </div>

    <h3>Key Database Tables</h3>
    <table>
      <tr>
        <th>Table</th>
        <th>Relevant Fields</th>
        <th>Purpose</th>
      </tr>
      <tr>
        <td><code>memberships</code></td>
        <td><code>meca_id</code> (INTEGER, UNIQUE)</td>
        <td>Primary storage for membership MECA IDs</td>
      </tr>
      <tr>
        <td><code>profiles</code></td>
        <td><code>meca_id</code> (TEXT)</td>
        <td>Display ID, special roles</td>
      </tr>
      <tr>
        <td><code>meca_id_history</code></td>
        <td><code>meca_id</code>, <code>membership_id</code>, etc.</td>
        <td>Audit trail of all ID assignments</td>
      </tr>
    </table>

    <h2 id="business-logic-summary">14. Business Logic Summary</h2>
    <p>This section provides a complete summary of all MECA ID business rules in one place:</p>

    <h3>ID Assignment Rules</h3>
    <table>
      <tr>
        <th>Rule</th>
        <th>Description</th>
      </tr>
      <tr>
        <td><strong>New Member</strong></td>
        <td>Gets next available ID from <code>get_next_meca_id()</code> (701500+)</td>
      </tr>
      <tr>
        <td><strong>Renewal ≤ 90 days</strong></td>
        <td>Keeps same MECA ID from previous membership</td>
      </tr>
      <tr>
        <td><strong>Renewal > 90 days</strong></td>
        <td>Gets a new MECA ID (old one is retired) — <em>Admin can override with password</em></td>
      </tr>
      <tr>
        <td><strong>Secondary Member</strong></td>
        <td>Always gets a new unique MECA ID</td>
      </tr>
      <tr>
        <td><strong>Legacy Import</strong></td>
        <td>Preserves original ID (1-701,499 range)</td>
      </tr>
      <tr>
        <td><strong>Special Role</strong></td>
        <td>Assigned to profile (not membership) for judges/EDs</td>
      </tr>
    </table>

    <h3>Membership Status Rules</h3>
    <table>
      <tr>
        <th>Status</th>
        <th>MECA ID Behavior</th>
        <th>Competition Eligibility</th>
      </tr>
      <tr>
        <td><span class="badge badge-yellow">Pending (Unpaid)</span></td>
        <td>Not yet assigned</td>
        <td>Cannot compete</td>
      </tr>
      <tr>
        <td><span class="badge badge-green">Active (Paid)</span></td>
        <td>Valid and active</td>
        <td>Can compete</td>
      </tr>
      <tr>
        <td><span class="badge badge-orange">Expired < 90 days</span></td>
        <td>Inactive (can be reactivated)</td>
        <td>Cannot compete until renewal</td>
      </tr>
      <tr>
        <td><span class="badge badge-red">Expired > 90 days</span></td>
        <td>Retired (cannot reuse)</td>
        <td>Must get new membership/ID</td>
      </tr>
    </table>

    <h3>Data Relationships</h3>
    <div class="card info">
      <h4>Entity Relationship</h4>
      <ul>
        <li><code>Profile</code> (user account) → can have multiple <code>Memberships</code></li>
        <li><code>Membership</code> → has exactly one <code>meca_id</code> (assigned when paid)</li>
        <li><code>CompetitionResult</code> → references <code>meca_id</code> for competitor tracking</li>
        <li><code>Standings</code> → aggregates points by <code>meca_id</code></li>
        <li><code>MecaIdHistory</code> → audit trail of all ID assignments</li>
      </ul>
    </div>

    <h3>Code Locations</h3>
    <table>
      <tr>
        <th>File</th>
        <th>Function</th>
        <th>Purpose</th>
      </tr>
      <tr>
        <td><code>memberships.service.ts</code></td>
        <td><code>assignMecaIdToMembership()</code></td>
        <td>Main ID assignment logic with 90-day rule</td>
      </tr>
      <tr>
        <td><code>master-secondary.service.ts</code></td>
        <td><code>markSecondaryPaid()</code></td>
        <td>Assigns ID to secondary when paid</td>
      </tr>
      <tr>
        <td><code>stripe.controller.ts</code></td>
        <td><code>handleInvoicePaid()</code></td>
        <td>Triggers ID assignment on payment</td>
      </tr>
      <tr>
        <td>Database function</td>
        <td><code>get_next_meca_id()</code></td>
        <td>Atomic next ID generation</td>
      </tr>
      <tr>
        <td><code>profiles.service.ts</code></td>
        <td><code>assignMecaIdToProfile()</code></td>
        <td>ID assignment for special roles</td>
      </tr>
    </table>

    <h3>Edge Cases</h3>
    <div class="card warning">
      <h4>Important Edge Cases Handled</h4>
      <ul>
        <li><strong>Concurrent payments:</strong> <code>get_next_meca_id()</code> is atomic - prevents duplicates</li>
        <li><strong>Multiple membership types:</strong> Each type gets its own ID (Competitor vs Retailer)</li>
        <li><strong>Self secondary:</strong> Uses master's name automatically, gets unique ID for vehicle</li>
        <li><strong>Legacy renewal after 90 days:</strong> Gets NEW ID in 701500+ range, not their legacy ID</li>
        <li><strong>Super Admin override:</strong> Password-protected endpoints allow bypassing 90-day rule or changing MECA IDs (audit trail created automatically)</li>
      </ul>
    </div>

    <h2 id="super-admin">15. Super Admin MECA ID Override (Protected)</h2>
    <p>In exceptional circumstances, administrators may need to override the standard MECA ID assignment rules. These operations require <strong>both admin role AND a special password</strong> for security.</p>

    <div class="card warning">
      <h4>⚠️ Password-Protected Operations</h4>
      <p>The following operations are protected by a special Super Admin password. This password should only be known by authorized personnel (e.g., Mick or designated admins).</p>
      <ul>
        <li>Overriding a MECA ID on an existing membership</li>
        <li>Bypassing the 90-day rule when renewing</li>
      </ul>
      <p><strong>Security:</strong> All Super Admin operations are logged in the <code>meca_id_history</code> table with the admin's user ID and reason for the change.</p>
    </div>

    <h3>15.1 Override MECA ID on Existing Membership</h3>
    <div class="card">
      <h4>Use Case</h4>
      <p>When a member needs a different MECA ID assigned to their existing membership (e.g., correcting an import error, honoring a legacy ID promise).</p>

      <h4>Requirements</h4>
      <ul>
        <li>User must have <span class="badge badge-purple">Admin</span> role</li>
        <li>Must provide Super Admin password</li>
        <li>Must provide a reason (logged for audit)</li>
        <li>New MECA ID must not already be in use</li>
      </ul>

      <h4>API Endpoint</h4>
      <div class="code-block">
<span class="function">PUT</span> /api/memberships/:id/admin/override-meca-id

<span class="comment">// Request body:</span>
{
  <span class="string">"newMecaId"</span>: <span class="number">500123</span>,
  <span class="string">"superAdminPassword"</span>: <span class="string">"[PROTECTED]"</span>,
  <span class="string">"reason"</span>: <span class="string">"Restoring legacy ID per member request"</span>
}
      </div>
    </div>

    <h3>15.2 Renew Membership Keeping Old MECA ID (After 90 Days)</h3>
    <div class="card">
      <h4>Use Case</h4>
      <p>When a member's membership has expired for more than 90 days but they have a valid reason to keep their old MECA ID (e.g., medical absence, military deployment, administrative error).</p>

      <h4>Requirements</h4>
      <ul>
        <li>User must have <span class="badge badge-purple">Admin</span> role</li>
        <li>Must provide Super Admin password</li>
        <li>Must provide a reason (logged for audit)</li>
        <li>Previous MECA ID must exist and belong to this user's previous membership</li>
        <li>Previous MECA ID must not be currently in use by an active membership</li>
      </ul>

      <h4>API Endpoint</h4>
      <div class="code-block">
<span class="function">POST</span> /api/memberships/admin/renew-keep-meca-id

<span class="comment">// Request body:</span>
{
  <span class="string">"userId"</span>: <span class="string">"uuid-of-member"</span>,
  <span class="string">"membershipTypeConfigId"</span>: <span class="string">"uuid-of-membership-type"</span>,
  <span class="string">"previousMecaId"</span>: <span class="number">701523</span>,
  <span class="string">"superAdminPassword"</span>: <span class="string">"[PROTECTED]"</span>,
  <span class="string">"reason"</span>: <span class="string">"Medical leave - doctor's note on file"</span>
}
      </div>
    </div>

    <h3>Audit Trail</h3>
    <div class="card info">
      <h4>History Record for Super Admin Operations</h4>
      <p>All Super Admin override operations create a detailed history record:</p>
      <div class="code-block">
<span class="comment">// Example meca_id_history record for override:</span>
{
  <span class="string">"meca_id"</span>: <span class="number">500123</span>,
  <span class="string">"membership_id"</span>: <span class="string">"membership-uuid"</span>,
  <span class="string">"notes"</span>: <span class="string">"SUPER ADMIN OVERRIDE by admin-uuid: Changed from 701500 to 500123. Reason: Restoring legacy ID per member request"</span>,
  <span class="string">"created_at"</span>: <span class="string">"2026-01-27T..."</span>
}
      </div>
    </div>

    <h3>Code Locations</h3>
    <table>
      <tr>
        <th>File</th>
        <th>Function</th>
        <th>Purpose</th>
      </tr>
      <tr>
        <td><code>memberships.controller.ts</code></td>
        <td><code>overrideMecaId()</code></td>
        <td>Endpoint for ID override</td>
      </tr>
      <tr>
        <td><code>memberships.controller.ts</code></td>
        <td><code>renewKeepMecaId()</code></td>
        <td>Endpoint for renewal with same ID</td>
      </tr>
      <tr>
        <td><code>memberships.service.ts</code></td>
        <td><code>superAdminOverrideMecaId()</code></td>
        <td>Override logic with validation</td>
      </tr>
      <tr>
        <td><code>memberships.service.ts</code></td>
        <td><code>renewMembershipKeepMecaId()</code></td>
        <td>Renewal logic bypassing 90-day rule</td>
      </tr>
      <tr>
        <td><code>memberships.api-client.ts</code></td>
        <td><code>superAdminOverrideMecaId()</code></td>
        <td>Frontend API method</td>
      </tr>
      <tr>
        <td><code>memberships.api-client.ts</code></td>
        <td><code>superAdminRenewKeepMecaId()</code></td>
        <td>Frontend API method</td>
      </tr>
    </table>

    <h2 id="troubleshooting">16. Troubleshooting</h2>

    <h3>Member has no MECA ID after payment</h3>
    <div class="card">
      <p><strong>Possible causes:</strong></p>
      <ol>
        <li>Payment not fully processed - check Stripe webhook logs</li>
        <li>For secondary memberships - check if <code>markSecondaryPaid()</code> was called</li>
        <li>Database error - check backend logs for <code>assignMecaIdToMembership</code> errors</li>
      </ol>
      <p><strong>Fix:</strong> Admin can manually trigger MECA ID assignment or assign via database</p>
    </div>

    <h3>Duplicate MECA IDs</h3>
    <div class="card">
      <p><strong>This should not happen</strong> due to the UNIQUE constraint on <code>memberships.meca_id</code>.</p>
      <p>If it does occur:</p>
      <ol>
        <li>Check for database constraint violations in logs</li>
        <li>Verify <code>get_next_meca_id()</code> function is working correctly</li>
        <li>Check for manual database modifications that bypassed the system</li>
      </ol>
    </div>

    <h3>Secondary showing same MECA ID as master</h3>
    <div class="card">
      <p><strong>Cause:</strong> The invoice payment webhook didn't call <code>markSecondaryPaid()</code></p>
      <p><strong>Fix:</strong></p>
      <ol>
        <li>Verify the Stripe webhook handler processes secondary membership invoices</li>
        <li>Manually call <code>markSecondaryPaid()</code> for affected memberships</li>
        <li>Assign a new unique MECA ID via SQL:
          <div class="code-block">
<span class="function">UPDATE</span> memberships
<span class="function">SET</span> meca_id = (<span class="function">SELECT</span> get_next_meca_id())
<span class="function">WHERE</span> id = <span class="string">'secondary-membership-uuid'</span>;
          </div>
        </li>
      </ol>
    </div>

    <h3>Member wants their old MECA ID back (after 90 days)</h3>
    <div class="card">
      <p><strong>Policy:</strong> After 90 days, MECA IDs cannot be reclaimed through the normal system.</p>
      <p><strong>Super Admin Override (Recommended):</strong></p>
      <ol>
        <li>Navigate to the member's detail page in Admin</li>
        <li>Use the "Override MECA ID" feature (requires Super Admin password)</li>
        <li>Enter the previous MECA ID and provide a reason</li>
        <li>The system automatically validates and creates an audit trail</li>
      </ol>
      <p>See <a href="#super-admin">Section 15: Super Admin MECA ID Override</a> for full details.</p>
      <p><strong>Manual Database Fix (Legacy/Emergency):</strong></p>
      <ol>
        <li>Verify no other membership is using that MECA ID</li>
        <li>Manually update the membership's <code>meca_id</code> field</li>
        <li>Create a history record noting the manual reassignment</li>
        <li>Document the exception in admin notes</li>
      </ol>
    </div>

    <hr style="margin: 40px 0; border: none; border-top: 1px solid #475569;">
    <p style="color: #64748b; font-size: 0.9rem;">Last updated: January 27, 2026 | MECA NewMECA V2 Documentation</p>
  </div>
</body>
</html>
